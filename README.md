# aru-raharja-backend

Rust backend starter using **Actix Web + Diesel (PostgreSQL)**.  
Goals: simple health endpoint, DB pool, and auto-migrations on startup.

## Why `.cargo/config.toml` exists

On Windows/MSVC, the PostgreSQL client library (**libpq**) and headers (**libpq-fe.h**) must be discoverable **at compile time** (for Diesel’s Postgres backend).  
We commit `.cargo/config.toml` so **Cargo always knows where libpq is** without re-exporting env vars every time.

```toml
# .cargo/config.toml (Windows local PostgreSQL)
[env]
PQ_LIB_DIR     = "C:\Program Files\PostgreSQL\17\lib"      # contains libpq.lib
PQ_INCLUDE_DIR = "C:\Program Files\PostgreSQL\17\include"  # contains libpq-fe.h
LIB            = "C:\Program Files\PostgreSQL\17\lib"
INCLUDE        = "C:\Program Files\PostgreSQL\17\include"
PATH           = "C:\Program Files\PostgreSQL\17\bin"
```

> If you build on Linux/WSL/CI, adjust/remove these as needed, or provide a platform-specific config.

---

## Requirements

- Rust (stable, MSVC toolchain on Windows)
- PostgreSQL (running locally)
- Diesel CLI (for migrations/schema generation)
- Visual Studio Build Tools (C++ workload) on Windows

---

## Quick start

### 1) Environment variables

Copy `.env.example` → `.env` and set your values:

```dotenv
DATABASE_URL=postgres://postgres:PASSWORD@localhost:PORT/DBNAME?sslmode=disable
APP_HOST=127.0.0.1
APP_PORT=8080
RUST_LOG=info
```

### 2) Start PostgreSQL (Windows)

```powershell
# Find service name (usually postgresql-x64-17)
Get-Service | findstr postgresql

# Start service
net start postgresql-x64-17

# Verify listening port
netstat -ano | findstr PORT
```

Create the DB if needed:

```powershell
psql -U postgres -h localhost -p PORT -d postgres -c 'CREATE DATABASE "DBNAME";'
```

### 3) Install Diesel CLI (one time)

```powershell
cargo install diesel_cli --no-default-features --features postgres
diesel --version
```

### 4) Diesel setup & schema

```powershell
diesel setup
diesel migration run
# IMPORTANT (Windows): ensure schema.rs is UTF-8
diesel print-schema | Out-File -Encoding utf8 src\schema.rs
```

### 5) Run

```powershell
cargo run
```

---

## Hot reload (dev)

```powershell
cargo install cargo-watch
cargo watch -x run
```

---

## Project layout

```
src/
  config/        # env config loader
  db/            # pool + embedded migrations
  routes/        # HTTP endpoints
  models/        # data models (structs for DB tables, API requests/responses, serialization)
  schema.rs      # generated by Diesel (UTF-8)
.cargo/config.toml
diesel.toml
migrations/
.env
```

---

## Common issues (Windows)

### ❌ `LINK : fatal error LNK1181: cannot open input file 'libpq.lib'`
- Ensure PostgreSQL **development files** are installed.
- Verify these paths exist:
  - `C:\Program Files\PostgreSQL\17\lib\libpq.lib`
  - `C:\Program Files\PostgreSQL\17\include\libpq-fe.h`
- `.cargo/config.toml` should point to those paths (see file above).
- Make sure you are using **MSVC toolchain**:
  ```powershell
  rustup show active-toolchain
  # should be: stable-x86_64-pc-windows-msvc
  ```
- If you still see errors, open a new terminal (to reload PATH) or run:
  ```powershell
  cargo clean
  cargo build -vv
  ```

### ❌ `stream did not contain valid UTF-8` for `src\schema.rs`
- Windows redirection often writes UTF-16. Regenerate schema with UTF-8:
  ```powershell
  diesel print-schema | Out-File -Encoding utf8 src\schema.rs
  ```

### ❌ Can’t connect to DB
- Verify service is running and port is correct:
  ```powershell
  netstat -ano | findstr PORT
  psql -U postgres -h localhost -p PORT -d postgres -c "SELECT 1;"
  ```
- Update `.env` `DATABASE_URL` accordingly.

---

## WSL/Linux alternative (easier linking)

```bash
sudo apt update
sudo apt install -y postgresql libpq-dev build-essential pkg-config
cargo install diesel_cli --no-default-features --features postgres
# Start/enable Postgres, create DB, then:
diesel setup
diesel migration run
diesel print-schema > src/schema.rs
cargo run
```

No `.cargo/config.toml` needed on Linux (libpq is found via `libpq-dev`).
